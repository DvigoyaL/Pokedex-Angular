<div class="min-h-screen">
  <!-- Mobile Filter Toggle Button (visible only on mobile) -->
  <button
    (click)="toggleFilterPanel()"
    class="fixed bottom-6 right-6 z-40 lg:hidden bg-yellow-400 text-white p-4 rounded-full shadow-lg hover:bg-yellow-500 transition"
    style="background-color: #fbc02d;"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
    </svg>
  </button>

  <!-- Overlay (mobile only) -->
  @if (isFilterPanelOpen) {
    <div
      class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
      (click)="closeFilterPanel()"
    ></div>
  }

  <!-- Sidebar with Filters -->
  <aside
    [class.translate-x-0]="isFilterPanelOpen"
    [class.-translate-x-full]="!isFilterPanelOpen"
    class="fixed top-0 lg:top-16 left-0 w-80 bg-white border-r border-gray-200 overflow-y-auto h-screen lg:h-[calc(100vh-4rem)] z-50 lg:z-10 transition-transform duration-300 lg:translate-x-0"
  >
    <!-- Close button (mobile only) -->
    <button
      (click)="closeFilterPanel()"
      class="absolute top-4 right-4 lg:hidden text-gray-600 hover:text-gray-800 z-10"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <app-filter-panel
      [firstFilterType]="filterStateData.firstFilter.type"
      (filterChange)="onFilterChange($event)"
    ></app-filter-panel>
  </aside>

  <!-- Main Content -->
  <main class="lg:ml-80 lg:pt-16 flex-1">
    <!-- Estado IDLE - Sin filtros aplicados -->
    @if (filterStateData.state === 'IDLE') {
      <div class="flex flex-col items-center justify-center py-20 px-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 text-gray-300 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
        </svg>
        <h2 class="text-2xl font-bold text-gray-700 mb-2">Selecciona un filtro para comenzar</h2>
        <p class="text-gray-500 text-center max-w-md">
          Elige un tipo, generación o hábitat para explorar Pokémon.
          Luego podrás refinar tu búsqueda con filtros de altura y peso.
        </p>
      </div>
    }

    <!-- Loading State -->
    @if (isLoading) {
      <div class="text-center my-8">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-yellow-400"></div>
        <p class="text-xl text-gray-600 mt-4">Cargando Pokémon...</p>
        @if (filterStateData.firstFilter.type === 'habitat' && filterStateData.firstFilter.value === 'unknown') {
          <p class="text-sm text-gray-500 mt-2">⏳ Esto puede tardar un poco más (buscando Pokémon sin hábitat en 8 generaciones)</p>
        }
      </div>
    }

    <!-- Error Message -->
    @if (error) {
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mx-8 mt-4">
        <p class="font-medium">{{ error }}</p>
      </div>
    }

    <!-- Results -->
    @if (filterStateData.state === 'PRIMARY_LOADED' && !isLoading) {
      @if (displayedPokemonList.length > 0) {
        <!-- Stats bar con filtros activos -->
        <div class="bg-yellow-50 border-b-2 border-yellow-400 px-8 py-4">
          <div class="flex items-start justify-between flex-wrap gap-2">
            <div>
              <p class="text-sm text-gray-700 mb-1">
                Mostrando <strong>{{ displayedPokemonList.length }}</strong> de
                <strong>{{ totalResults }}</strong> Pokémon
              </p>
              <div class="flex flex-wrap gap-2 mt-2">
                <!-- Filtro principal (el que llamó a la API) -->
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-blue-600 text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                  </svg>
                  @if (filterStateData.firstFilter.type === 'type') {
                    Tipo: {{ filterStateData.firstFilter.value }}
                  } @else if (filterStateData.firstFilter.type === 'generation') {
                    Gen {{ filterStateData.firstFilter.value }}
                  } @else if (filterStateData.firstFilter.type === 'habitat') {
                    Hábitat: {{ filterStateData.firstFilter.value }}
                  }
                </span>

                <!-- Filtros adicionales aplicados localmente -->
                @for (type of filterStateData.additionalPrimaryFilters.types; track type) {
                  @if (type !== filterStateData.firstFilter.value || filterStateData.firstFilter.type !== 'type') {
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">
                      Tipo: {{ type }}
                    </span>
                  }
                }
                @for (gen of filterStateData.additionalPrimaryFilters.generations; track gen) {
                  @if (gen !== filterStateData.firstFilter.value || filterStateData.firstFilter.type !== 'generation') {
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">
                      Gen {{ gen }}
                    </span>
                  }
                }
                @for (habitat of filterStateData.additionalPrimaryFilters.habitats; track habitat) {
                  @if (habitat !== filterStateData.firstFilter.value || filterStateData.firstFilter.type !== 'habitat') {
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-200 text-gray-700">
                      Hábitat: {{ habitat }}
                    </span>
                  }
                }
              </div>
            </div>
            <div class="text-xs text-gray-600">
              <p class="flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                = Filtro principal (API)
              </p>
            </div>
          </div>
        </div>

        <ul class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-7 gap-4 p-8">
          @for (pokemon of displayedPokemonList; track pokemon.id) {
            <pokedex-pokemon-basic-card
              [pokemon]="pokemon"
              [backgroundColor]="getColorForType(pokemon.types[0].type.name)"
              [showFavoriteButton]="true"
              [isFavorite]="isFavorite(pokemon.id)"
              (cardClicked)="selectPokemon($event)"
              (favoriteToggled)="onFavoriteToggled($event)"
            />
          }
        </ul>

        <!-- Navigation Buttons -->
        <pokedex-pokemon-navigationButtons
          [offset]="currentPage * itemsPerPage"
          [isLoading]="isLoading"
          (previousClicked)="onPreviousPage()"
          (nextClicked)="onNextPage()"
        />
      } @else {
        <div class="text-center py-20">
          <p class="text-xl text-gray-600">No se encontraron Pokémon con los filtros seleccionados</p>
          <p class="text-sm text-gray-500 mt-2">Intenta ajustar los filtros de altura y peso</p>
        </div>
      }
    }
  </main>
</div>

<!-- Modal for Pokemon Details -->
@if (selectedPokemon) {
  <pokedex-pokemon-modal-card
    [pokemon]="selectedPokemon"
    [pokemonList]="displayedPokemonList"
    (modalClosed)="closeModal()"
    (pokemonSelected)="selectPokemon($event)"
  />
}

